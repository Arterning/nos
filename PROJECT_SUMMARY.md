# NOS 项目总结

## 项目概述

NOS是一个用C语言编写的简单教学操作系统，运行在RISC-V 64位架构上。项目包含了操作系统的核心组件，非常适合学习操作系统原理。

## 文件清单

### 启动代码 (boot/)

| 文件 | 行数 | 说明 |
|------|------|------|
| `boot/start.S` | 38 | RISC-V汇编启动代码，设置栈、清空BSS、跳转到C代码 |
| `boot/linker.ld` | 30 | 链接脚本，定义内核内存布局 |

### 头文件 (include/)

| 文件 | 说明 |
|------|------|
| `include/kernel/types.h` | 基础类型定义 (uint64_t, size_t等) |
| `include/kernel/string.h` | 字符串函数声明 |
| `include/kernel/printk.h` | 内核打印函数 |
| `include/kernel/mm.h` | 内存管理接口 |
| `include/kernel/trap.h` | 中断/异常处理 |
| `include/kernel/process.h` | 进程管理 |
| `include/kernel/fs.h` | 文件系统 |
| `include/kernel/shell.h` | Shell接口 |
| `include/arch/riscv/riscv.h` | RISC-V架构定义 |

### 内核代码 (kernel/)

#### 主程序
- `kernel/main.c`: 内核初始化和主函数

#### 架构相关 (kernel/arch/riscv/)
- `kernel/arch/riscv/trap.S`: 中断/异常入口和上下文保存
- `kernel/arch/riscv/trap.c`: 中断处理逻辑
- `kernel/arch/riscv/switch.S`: 进程上下文切换

#### 内存管理 (kernel/mm/)
- `kernel/mm/pmm.c`: 物理内存管理 (Bitmap分配器)
- `kernel/mm/vmm.c`: 虚拟内存管理 (Sv39页表)

#### 进程管理 (kernel/process/)
- `kernel/process/process.c`: 进程调度器 (时间片轮转)

#### 文件系统 (kernel/fs/)
- `kernel/fs/fs.c`: 简单内存文件系统

#### 驱动 (kernel/drivers/)
- `kernel/drivers/shell.c`: 交互式命令行Shell

### 库函数 (lib/)

- `lib/string.c`: 字符串操作函数 (memset, memcpy, strcmp等)
- `lib/printk.c`: 内核打印函数 (printk, puts, putchar)

### 构建和文档

- `Makefile`: 项目构建文件
- `README.md`: 项目文档
- `INSTALL_WINDOWS.md`: Windows安装指南
- `run.sh`: 快速启动脚本
- `.gitignore`: Git忽略文件

## 系统架构

```
┌─────────────────────────────────────┐
│          Shell (用户界面)           │
├─────────────────────────────────────┤
│       文件系统    │   进程管理      │
├─────────────────────────────────────┤
│       内存管理 (物理/虚拟)          │
├─────────────────────────────────────┤
│       中断/异常处理                 │
├─────────────────────────────────────┤
│       硬件抽象层 (RISC-V)           │
├─────────────────────────────────────┤
│       硬件 (UART, 内存, CPU)        │
└─────────────────────────────────────┘
```

## 关键实现

### 1. 启动流程

```
boot/start.S (汇编)
    ↓
清空BSS段
    ↓
设置栈指针
    ↓
kernel_main() (C语言)
    ↓
初始化各子系统
    ↓
启动Shell
```

### 2. 内存管理

**物理内存**:
- 使用bitmap跟踪页的分配状态
- 每页4KB
- 支持128MB物理内存

**虚拟内存**:
- Sv39三级页表
- 恒等映射（简化实现）
- 支持页表创建和映射

### 3. 进程调度

**数据结构**:
```c
- PCB (进程控制块)
  - 进程ID
  - 状态 (就绪/运行/睡眠/僵尸)
  - 上下文 (寄存器)
  - 内核栈
```

**调度算法**:
- 时间片轮转 (Round Robin)
- 就绪队列
- 协作式调度 (通过yield())

### 4. 文件系统

**特点**:
- 基于内存的简单文件系统
- 支持最多32个文件
- 每个文件最大64KB
- 支持创建、删除、读、写操作

### 5. Shell命令

实现的命令:
- `help` - 帮助
- `ls` - 列出文件
- `cat` - 显示文件内容
- `ps` - 进程列表
- `mem` - 内存信息
- `echo` - 打印消息
- `clear` - 清屏
- `about` - 关于信息

## 代码统计

| 组件 | 文件数 | 代码行数(估计) |
|------|--------|---------------|
| 启动代码 | 2 | 70 |
| 头文件 | 9 | 200 |
| 内核核心 | 1 | 50 |
| 架构相关 | 3 | 200 |
| 内存管理 | 2 | 250 |
| 进程管理 | 1 | 180 |
| 文件系统 | 1 | 150 |
| Shell | 1 | 250 |
| 库函数 | 2 | 200 |
| **总计** | **22** | **~1550** |

## 教学价值

这个操作系统非常适合教学，因为：

1. **代码量适中**: 约1500行C/汇编代码，易于理解
2. **模块化设计**: 各组件职责清晰
3. **涵盖核心概念**:
   - 启动过程
   - 内存管理
   - 进程调度
   - 中断处理
   - 文件系统
   - 设备驱动

4. **可扩展性**: 易于添加新功能:
   - 用户态进程
   - 系统调用
   - 更复杂的调度算法
   - 真实的磁盘文件系统
   - 网络支持

## 可能的扩展方向

### 基础扩展
1. 完善时钟中断，实现抢占式调度
2. 添加优先级调度算法
3. 实现进程间通信 (IPC)
4. 添加更多Shell命令

### 中级扩展
1. 实现系统调用机制
2. 用户态进程支持
3. 实现真实的文件系统 (如FAT)
4. 添加块设备驱动

### 高级扩展
1. 多核支持 (SMP)
2. 网络协议栈
3. 图形界面
4. 动态加载程序

## 运行要求

- **CPU**: RISC-V 64位 (模拟器)
- **内存**: 128MB
- **设备**: UART串口

## 已知限制

1. 不支持真实硬件 (仅QEMU)
2. 时钟中断未完全实现
3. 没有用户态/内核态分离
4. 文件系统仅存在于内存中
5. 单核运行

## 开发建议

### 调试技巧
1. 使用`printk()`添加调试信息
2. 使用GDB远程调试
3. 查看QEMU输出日志

### 修改建议
1. 先理解现有代码
2. 在小范围内测试修改
3. 保持代码风格一致
4. 添加注释说明

## 参考资料

- RISC-V指令集手册
- xv6操作系统
- Linux内核源码
- QEMU文档

## 总结

NOS是一个精心设计的教学操作系统，代码简洁清晰，非常适合：
- 操作系统课程实验
- 自学操作系统原理
- 嵌入式系统开发入门
- RISC-V架构学习

项目已包含完整的文档和安装指南，可以直接使用！
